<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball x Pit – Evolutions & Passives Checklist</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>
<body class="bg-[#211B1B] text-gray-100 p-4">
<div id="app" class="max-w-6xl mx-auto">
  <header class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Ball x Pit Checklist</h1>
    <p class="text-gray-400 mb-4">Autosaves in localStorage • Tracks Evolutions & Passives</p>
    <div class="flex flex-wrap gap-2 mb-4">
      <input v-model="search" type="search" placeholder="Filter..." class="flex-1 py-2 px-6 rounded-full bg-white/10 text-gray-100 outline-none" />
      <button @click="clearAll" class="px-4 py-2 rounded-full bg-red-600/20 hover:bg-red-700">Clear all</button>
      <button @click="exportData" class="px-4 py-2 rounded-full bg-blue-600/20 hover:bg-blue-700">Export</button>
      <button @click="importData" class="px-4 py-2 rounded-full bg-green-600/20 hover:bg-green-700">Import</button>
    </div>
  </header>

  <section class="mb-8" v-if="evolutions.length">
    <h2 class="text-2xl font-semibold mb-2">Ball Evolutions</h2>
    <p class="text-gray-400 mb-2">{{ collectedCount(evolutions) }} / {{ evolutions.length }} collected</p>
    <div class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
      <div v-for="item in filtered(evolutions)" :key="item.name" @click="toggle(item)" class="flex p-3 bg-white/10 rounded-lg cursor-pointer hover:bg-white-20 transition border border-white/0" :class="{ 'border border-[#744427]': state[item.name] === true, 'grayscale': state[item.name] !== true }">
        <div class="flex flex-col w-full">
          <div class="flex w-full items-start">
            <img :src="`icons/${item.name}.png`" :alt="item.name" :title="item.name" class="size-20 mr-3" />
            <span class="font-semibold">{{ item.name }}</span>
          </div>

          <div class="flex flex-col items-center mt-1">
            <div v-for="recipe in item.recipes" class="flex flex-row gap-2 bg-white/10 rounded px-3 py-2 my-0.5">
              <div v-for="(entry, index) in recipe" class="flex flex-row gap-2 items-center">
                <img :src="`icons/${entry}.png`" class="size-16" :alt="entry" :title="entry" />
                <span v-if="index < recipe.length - 1">&#x2715;</span>
              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </section>

  <section v-if="passives.length">
    <h2 class="text-2xl font-semibold mb-2">Passives</h2>
    <p class="text-gray-400 mb-2">{{ collectedCount(passives) }} / {{ passives.length }} collected</p>
    <div class="grid gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
      <div v-for="item in filtered(passives)" :key="item.name" @click="toggle(item)" class="flex p-3 bg-white/10 rounded-lg cursor-pointer hover:bg-white-20 transition border border-white/0" :class="{ 'border border-[#744427]': state[item.name] === true, 'grayscale': state[item.name] !== true }">
        <div class="flex flex-col w-full">
          <div class="flex w-full items-start">
            <img :src="`icons/${item.name}.png`" :alt="item.name" :title="item.name" class="size-20 mr-3" />
            <span class="font-semibold">{{ item.name }}</span>
          </div>

          <div class="flex flex-col items-center mt-1">
            <div v-for="recipe in item.recipes" class="flex flex-row gap-2 bg-white/10 rounded px-3 py-2 my-0.5">
              <div v-for="(entry, index) in recipe" class="flex flex-row gap-2 items-center">
                <img :src="`icons/${entry}.png`" class="size-16" :alt="entry" :title="entry" />
                <span v-if="index < recipe.length - 1">&#x2715;</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <footer class="mt-8 text-gray-400">Storage key: <code>ballxpitChecklist.v1</code> • Export format: compact bitset (BX1)</footer>
</div>

<script>
const { createApp, reactive, ref } = Vue;

createApp({
  setup() {
    const evolutions = ref([
      { name: "Assassin", recipes: [['Iron', 'Ghost'], ['Iron', 'Dark']] },
      { name: "Berserk", recipes: [['Charm', 'Burn'], ['Charm', 'Bleed']] },
      { name: "Black Hole", recipes: [['Dark', 'Sun']] },
      { name: "Blizzard", recipes: [['Freeze', 'Lightning'], ['Freeze', 'Wind']] },
      { name: "Bomb", recipes: [['Burn','Iron']]  },
      { name: "Flash", recipes: [['Lightning', 'Light']] },
      { name: "Flicker", recipes: [['Light', 'Dark']] },
      { name: "Freeze Ray", recipes: [['Freeze', 'Laser (Horizontal)'], ['Freeze','Laser (Vertical)']] },
      { name: "Frozen Flame", recipes: [['Burn', 'Freeze']] },
      { name: "Glacier", recipes: [['Freeze','Earthquake']] },
      { name: "Hemorrhage", recipes: [['Bleed','Iron']] },
      { name: "Holy Laser", recipes: [['Laser (Horizontal)','Laser (Vertical)']] },
      { name: "Incubus", recipes: [['Charm','Dark']] },
      { name: "Inferno", recipes: [['Burn','Wind']] },
      { name: "Laser Beam", recipes: [['Laser (Horizontal)', 'Light'], ['Laser (Vertical)', 'Light']] },
      { name: "Leech", recipes: [['Brood Mother','Bleed']] },
      { name: "Lightning Rod", recipes: [['Lightning','Iron']] },
      { name: "Lovestruck", recipes: [['Charm','Light'],['Charm','Lightning']] },
      { name: "Maggot", recipes: [['Cell', 'Brood Mother']] },
      { name: "Magma", recipes: [['Burn','Earthquake']] },
      { name: "Mosquito King", recipes: [['Vampire','Brood Mother']] },
      { name: "Mosquito Swarm", recipes: [['Vampire','Egg Sac']] },
      { name: "Noxious", recipes: [['Poison','Wind'],['Dark','Wind']] },
      { name: "Nuclear Bomb", recipes: [['Bomb', 'Poison']] },
      { name: "Overgrowth", recipes: [['Earthquake','Cell']] },
      { name: "Phantom", recipes: [['Dark','Ghost']] },
      { name: "Radiation Beam", recipes: [['Laser (Horizontal)','Poison'],['Laser (Horizontal)', 'Cell']] },
      { name: "Sacrifice", recipes: [['Bleed','Dark']] },
      { name: "Sandstorm", recipes: [['Earthquake','Wind']] },
      { name: "Satan", recipes: [['Incubus','Succubus']] },
      { name: "Shotgun", recipes: [['Iron','Egg Sac']] },
      { name: "Soul Sucker", recipes: [['Vampire','Ghost']] },
      { name: "Spider Queen", recipes: [['Brood Mother','Egg Sac']] },
      { name: "Storm", recipes: [['Lightning','Wind']] },
      { name: "Succubus", recipes: [['Charm','Vampire']] },
      { name: "Sun", recipes: [['Burn','Light']] },
      { name: "Swamp", recipes: [['Poison','Earthquake']] },
      { name: "Vampire Lord", recipes: [['Vampire','Bleed'], ['Vampire','Dark']] },
      { name: "Virus", recipes: [['Ghost','Poison'],['Cell','Poison']] },
      { name: "Voluptuous Egg Sac", recipes: [['Egg Sac','Cell']] },
      { name: "Wraith", recipes: [['Freeze','Ghost']] },
      { name: "Nosferatu", recipes: [['Mosquito King', 'Spider Queen', 'Vampire Lord']] }
    ]);

    const passives = ref([
      { name: "Cornucopia", recipes: [['Baby Rattle','War Horn']] },
      { name: "Gracious Impaler", recipes: [['Reacher\'s Spear', 'Deadeye\'s Amulet']] },
      { name: "Odiferous Shell", recipes: [['Wretched Onion','Breastplate']] },
      { name: "Phantom Regalia", recipes: [['Ghostly Corset', 'Ethereal Cloak']] },
      { name: "Soul Reaver", recipes: [['Vampiric Sword','Everflowing Goblet']] },
      { name: "Tormentor\'s Mask", recipes: [['Spiked Collar','Crown of Thorns']] },
      { name: "Wings of the Anointed", recipes: [['Radiant Feather','Fleet Feet']] },
      { name: "Deadeye\'s Cross", recipes: [[
        'Diamond Hilted Dagger',
        'Sapphire Hilted Dagger',
        'Ruby Hilted Dagger',
        'Emerald Hilted Dagger'
      ]] }
    ]);

    const STORAGE_KEY = 'ballxpitChecklist.v1';
    const state = reactive(JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'));
    const search = ref('');

    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function toggle(item) { state[item.name] = !state[item.name]; save(); }
    function collectedCount(list) { return list.filter(i => state[i.name]).length; }
    function filtered(list) {
      return list.filter(function(i) {
        let a = i.recipes.flat().map(i => i.toLowerCase())


        return i.name.toLowerCase().includes(search.value.toLowerCase())
          || searchArray(a, search.value.toLowerCase()).length > 0;
      })
    }

    function clearAll() { if(confirm('Clear all?')) { Object.keys(state).forEach(k => delete state[k]); save(); } }

    // Helper: unified ordered list of items (stable indices)
    function allItemNames() {
      return evolutions.value.map(i => i.name).concat(passives.value.map(i => i.name));
    }

    // Helper: Base64URL encode/decode for small byte arrays
    function b64urlEncode(bytes) {
      let binary = '';
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      const b64 = btoa(binary);
      return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/,'');
    }
    function b64urlDecode(str) {
      let b64 = str.replace(/-/g, '+').replace(/_/g, '/');
      // pad to multiple of 4
      while (b64.length % 4) b64 += '=';
      const binary = atob(b64);
      const out = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) out[i] = binary.charCodeAt(i);
      return out;
    }

    // New: compact bitset export (prefix BX1:)
    function exportData() {
      const names = allItemNames();
      const bitCount = names.length;
      const byteCount = Math.ceil(bitCount / 8);
      const bytes = new Uint8Array(byteCount);
      for (let idx = 0; idx < bitCount; idx++) {
        const name = names[idx];
        if (state[name]) {
          const byteIndex = (idx / 8) | 0;
          const bitIndex = idx % 8;
          bytes[byteIndex] |= (1 << bitIndex);
        }
      }
      // Optional tiny header with length to allow future list growth without ambiguity
      // Layout: [N (uint16 little-endian)] [bitset...]
      const header = new Uint8Array(2 + bytes.length);
      header[0] = bitCount & 0xFF;
      header[1] = (bitCount >>> 8) & 0xFF;
      header.set(bytes, 2);
      const encoded = b64urlEncode(header);
      alert(`BX1:${encoded}`);
    }

    function searchArray(array, searchTerm) {
      return array.filter(item => item.includes(searchTerm));
    }

    function importData() {
      const input = prompt('Import the string:');
      if (!input) return;
      // Try compact BX1 first; fallback to legacy deflate+base64 JSON
      if (input.startsWith('BX1:')) {
        try {
          const payload = input.slice(4);
          const raw = b64urlDecode(payload);
          const bitCount = raw[0] | (raw[1] << 8);
          const names = allItemNames();
          if (bitCount > names.length) {
            throw new Error('Import expects more items than this build knows.');
          }
          const bytes = raw.subarray(2);
          // Clear current state
          Object.keys(state).forEach(k => delete state[k]);
          for (let idx = 0; idx < bitCount; idx++) {
            const byteIndex = (idx / 8) | 0;
            const bitIndex = idx % 8;
            const on = (bytes[byteIndex] >> bitIndex) & 1;
            if (on) state[names[idx]] = true;
          }
          save();
          alert('Imported successfully (BX1).');
          return;
        } catch (e) {
          console.error('BX1 import failed, trying legacy...', e);
        }
      }
      try {
        const compressed = Uint8Array.fromBase64(input);
        const jsonStr = pako.inflate(compressed, { to: 'string' });
        const data = JSON.parse(jsonStr);
        Object.keys(state).forEach(k => delete state[k]);
        Object.assign(state, data);
        save();
        alert('Imported successfully (legacy).');
      } catch (e) {
        console.error(e);
        alert('Import failed. Check your string.');
      }
    }

    return { evolutions, passives, state, search, toggle, collectedCount, filtered, clearAll, exportData, importData };
  }
}).mount('#app');
</script>
</body>
</html>
